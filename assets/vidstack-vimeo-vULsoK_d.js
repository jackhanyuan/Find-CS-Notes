import{ad as E,av as a,z as y,aw as T,e as m,ai as u,k as q,az as R,am as p,l as I,aH as j,aC as w}from"./vidstack-UGaMhNs3-oMaa63Ea.js";import{R as M}from"./vidstack-4poYsikJ-MXwFu5ml.js";import{E as P,t as $}from"./vidstack-ZXJzvCCj-WBa9eMGD.js";import"./app-vmUhBKiq.js";const S=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"],c=class c extends P{constructor(){super(...arguments),this.$$PROVIDER_TYPE="VIMEO",this.scope=E(),this.j=0,this.k=new a(0,0),this.g=new a(0,0),this.d=null,this.e=null,this.l=null,this.f=y(""),this.i=y(!1),this.m=null,this.n=null,this.x=null,this.o=new M(this.y.bind(this)),this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF"}get a(){return this.b.delegate.a}get type(){return"vimeo"}get currentSrc(){return this.n}get videoId(){return this.f()}get hash(){return this.m}get isPro(){return this.i()}preconnect(){const t=[this.p(),"https://i.vimeocdn.com","https://f.vimeocdn.com","https://fresnel.vimeocdn.com"];for(const e of t)T(e,"preconnect")}setup(t){this.b=t,super.setup(t),m(this.z.bind(this)),m(this.A.bind(this)),m(this.B.bind(this)),this.a("provider-setup",this)}destroy(){this.q(),this.c("destroy")}async play(){const{paused:t}=this.b.$state;if(u(t))return this.d||(this.d=$(()=>{if(this.d=null,t())return"Timed out."}),this.c("play")),this.d.promise}async pause(){const{paused:t}=this.b.$state;if(!u(t))return this.e||(this.e=$(()=>{if(this.e=null,!t())return"Timed out."}),this.c("pause")),this.e.promise}setMuted(t){this.c("setMuted",t)}setCurrentTime(t){this.c("seekTo",t)}setVolume(t){this.c("setVolume",t),this.c("setMuted",u(this.b.$state.muted))}setPlaybackRate(t){this.c("setPlaybackRate",t)}async loadSource(t){if(!q(t.src)){this.n=null,this.m=null,this.f.set("");return}const e=t.src.match(c.v),s=e==null?void 0:e[1],i=e==null?void 0:e[2];this.f.set(s??""),this.m=i??null,this.n=t}z(){this.q();const t=this.f();if(!t){this.r.set("");return}this.r.set(`${this.p()}/video/${t}`)}A(){const t=this.r(),e=this.f(),s=c.w,i=s.get(e);if(!e)return;const h=R();if(this.l=h,i){h.resolve(i);return}const r=`https://vimeo.com/api/oembed.json?url=${t}`,o=new AbortController;return window.fetch(r,{mode:"cors",signal:o.signal}).then(n=>n.json()).then(n=>{var v,k;const f=/vimeocdn.com\/video\/(.*)?_/,l=(k=(v=n==null?void 0:n.thumbnail_url)==null?void 0:v.match(f))==null?void 0:k[1],b=l?`https://i.vimeocdn.com/video/${l}_1920x1080.webp`:"",d={title:(n==null?void 0:n.title)??"",duration:(n==null?void 0:n.duration)??0,poster:b,pro:n.account_type!=="basic"};s.set(e,d),h.resolve(d)}).catch(n=>{h.reject(),this.a("error",{message:`Failed to fetch vimeo video info from \`${r}\`.`,code:1})}),()=>{h.reject(),o.abort()}}B(){const t=this.i(),{$state:e,qualities:s}=this.b;if(e.canSetPlaybackRate.set(t),s[p.R](!t),t)return I(s,"change",()=>{var h;if(s.auto)return;const i=(h=s.selected)==null?void 0:h.id;i&&this.c("setQuality",i)})}p(){return"https://player.vimeo.com"}S(){const{$iosControls:t}=this.b,{keyDisabled:e}=this.b.$props,{controls:s,playsinline:i}=this.b.$state,h=s()||t();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:h,h:this.hash,keyboard:h&&!e(),transparent:!0,playsinline:i(),dnt:!this.cookies}}y(){this.c("getCurrentTime")}C(t,e){const{currentTime:s,paused:i,seeking:h,bufferedEnd:r}=this.b.$state;if(h()&&i()&&(this.c("getBuffered"),r()>t&&this.a("seeked",t,e)),s()===t)return;const o=s(),n={currentTime:t,played:this.j>=t?this.k:this.k=new a(0,this.j=t)};this.a("time-update",n,e),Math.abs(o-t)>1.5&&(this.a("seeking",t,e),!i()&&r()<t&&this.a("waiting",void 0,e))}D(t,e){this.a("seeked",t,e)}E(t){var s;const e=this.f();(s=this.l)==null||s.promise.then(i=>{if(!i)return;const{title:h,poster:r,duration:o,pro:n}=i,{$iosControls:f}=this.b,{controls:l}=this.b.$state,b=l()||f();this.o.T(),this.i.set(n),this.g=new a(0,o),this.a("poster-change",r,t),this.a("title-change",h,t),this.a("duration-change",o,t);const d={buffered:new a(0,0),seekable:this.g,duration:o};this.b.delegate.U(d,t),b||this.c("_hideOverlay"),this.c("getQualities")}).catch(i=>{e===this.f()&&this.a("error",{message:`Failed to fetch oembed data: ${i}`,code:2})})}F(t,e,s){switch(t){case"getCurrentTime":this.C(e,s);break;case"getBuffered":j(e)&&e.length&&this.s(e[e.length-1][1],s);break;case"setMuted":this.t(u(this.b.$state.volume),e,s);break;case"getChapters":break;case"getQualities":this.G(e,s);break}}H(){for(const t of S)this.c("addEventListener",t)}I(t){var e;this.a("pause",void 0,t),(e=this.e)==null||e.resolve(),this.e=null}J(t){var e;this.a("play",void 0,t),(e=this.d)==null||e.resolve(),this.d=null}K(t){const{paused:e}=this.b.$state;e()||this.a("playing",void 0,t)}s(t,e){const s={buffered:new a(0,t),seekable:this.g};this.a("progress",s,e)}L(t){this.a("waiting",void 0,t)}M(t){const{paused:e}=this.b.$state;e()||this.a("playing",void 0,t)}N(t){const{paused:e}=this.b.$state;e()&&this.a("play",void 0,t),this.a("waiting",void 0,t)}t(t,e,s){const i={volume:t,muted:e};this.a("volume-change",i,s)}G(t,e){this.b.qualities[w.V]=t.some(s=>s.id==="auto")?()=>{this.c("setQuality","auto")}:void 0;for(const s of t){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[p.W]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},e)}this.u(t.find(s=>s.active),e)}u({id:t}={},e){if(!t)return;const s=t==="auto",i=this.b.qualities.toArray().find(h=>h.id===t);s?(this.b.qualities[w.X](s,e),this.b.qualities[p.O](void 0,!0,e)):this.b.qualities[p.O](i,!0,e)}P(t,e,s){switch(t){case"ready":this.H();break;case"loaded":this.E(s);break;case"play":this.J(s);break;case"playprogress":this.K(s);break;case"pause":this.I(s);break;case"loadprogress":this.s(e.seconds,s);break;case"waiting":this.N(s);break;case"bufferstart":this.L(s);break;case"bufferend":this.M(s);break;case"volumechange":this.t(e.volume,u(this.b.$state.muted),s);break;case"durationchange":this.g=new a(0,e.duration),this.a("duration-change",e.duration,s);break;case"playbackratechange":this.a("rate-change",e.playbackRate,s);break;case"qualitychange":this.u(e,s);break;case"fullscreenchange":this.a("fullscreen-change",e.fullscreen,s);break;case"enterpictureinpicture":this.a("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.a("picture-in-picture-change",!1,s);break;case"ended":this.a("end",void 0,s);break;case"error":this.Q(e,s);break;case"seeked":this.D(e.seconds,s);break}}Q(t,e){var s;if(t.method==="play"){(s=this.d)==null||s.reject(t.message);return}}Y(t,e){t.event?this.P(t.event,t.data,e):t.method&&this.F(t.method,t.value,e)}Z(){}c(t,e){return this._({method:t,value:e})}q(){this.o.$(),this.j=0,this.k=new a(0,0),this.g=new a(0,0),this.d=null,this.e=null,this.l=null,this.x=null,this.i.set(!1)}};c.v=/(?:https:\/\/)?(?:player\.)?vimeo(?:\.com)?\/(?:video\/)?(\d+)(?:\?hash=(.*))?/,c.w=new Map;let C=c;export{C as VimeoProvider};
