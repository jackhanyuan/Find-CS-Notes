import{aB as m,k as l,aw as E,ai as p,al as h,aC as g,l as v,e as T,at as L,au as b,am as u,aD as S,an as w,aE as $,aF as D,i as C,aG as I}from"./vidstack-UGaMhNs3-oMaa63Ea.js";import{VideoProvider as O}from"./vidstack-video-B-_kriFF.js";import{R}from"./vidstack-4poYsikJ-MXwFu5ml.js";import"./app-vmUhBKiq.js";import"./vidstack-html-3tHWnf0r.js";const _=a=>I(a);class q{constructor(t){this.gc=null,this.hc=null,this.ea={},this.fa=new Set,this.$a=t}get instance(){return this.gc}setup(t,i){this.b=i;const e=p(i.$state.streamType).includes("live"),r=p(i.$state.streamType).includes("ll-");this.gc=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.ea});const s=this.ic.bind(this);for(const o of Object.values(t.Events))this.gc.on(o,s);this.gc.on(t.Events.ERROR,this.Q.bind(this));for(const o of this.fa)o(this.gc);i.player.dispatch(new h("hls-instance",{detail:this.gc})),this.gc.attachMedia(this.$a),this.gc.on(t.Events.AUDIO_TRACK_SWITCHED,this.jc.bind(this)),this.gc.on(t.Events.LEVEL_SWITCHED,this.kc.bind(this)),this.gc.on(t.Events.LEVEL_LOADED,this.lc.bind(this)),this.gc.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.mc.bind(this)),this.gc.on(t.Events.CUES_PARSED,this.nc.bind(this)),i.qualities[g.V]=this.oc.bind(this),v(i.qualities,"change",this.u.bind(this)),v(i.audioTracks,"change",this.pc.bind(this)),this.hc=T(this.qc.bind(this))}qc(){if(!this.b.$state.live())return;const t=new R(this.rc.bind(this));return t.T(),t.$.bind(t)}rc(){var t;this.b.$state.liveSyncPosition.set(((t=this.gc)==null?void 0:t.liveSyncPosition)??1/0)}ic(t,i){var e;(e=this.b.player)==null||e.dispatch(new h(_(t),{detail:i}))}mc(t,i){const e=new h(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const o=i.tracks[s],n=o.subtitleTrack??o.closedCaptions,c=new L({id:`hls-${o.kind}${s}`,src:n==null?void 0:n.url,label:o.label,language:n==null?void 0:n.lang,kind:o.kind});c[b.rb]=2,c[b.Ab]=()=>{c.mode==="showing"?(this.gc.subtitleTrack=s,r=s):r===s&&(this.gc.subtitleTrack=-1,r=-1)},o.default&&c.setMode("showing",e),this.b.textTracks.add(c,e)}}nc(t,i){const e=this.b.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new h(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}jc(t,i){const e=this.b.audioTracks[i.id];e&&this.b.audioTracks[u.O](e,!0,new h(t,{detail:i}))}kc(t,i){const e=this.b.qualities[i.level];e&&this.b.qualities[u.O](e,!0,new h(t,{detail:i}))}lc(t,i){if(this.b.$state.canPlay())return;const{type:e,live:r,totalduration:s,targetduration:o}=i.details,n=new h(t,{detail:i});this.b.delegate.a("stream-type-change",r?e==="EVENT"&&Number.isFinite(s)&&o>=10?"live:dvr":"live":"on-demand",n),this.b.delegate.a("duration-change",s,n);const c=this.gc.media;this.gc.currentLevel===-1&&this.b.qualities[g.X](!0,n);for(const d of this.gc.audioTracks)this.b.audioTracks[u.W]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.gc.levels)this.b.qualities[u.W]({id:(d.id??d.height+"p")+"",width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);c.dispatchEvent(new h("canplay",{trigger:n}))}Q(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.gc)==null||e.startLoad();break;case"mediaError":(r=this.gc)==null||r.recoverMediaError();break;default:(s=this.gc)==null||s.destroy(),this.gc=null;break}}oc(){this.gc&&(this.gc.currentLevel=-1)}u(){const{qualities:t}=this.b;!this.gc||t.auto||(this.gc[t.switch+"Level"]=t.selectedIndex,S&&(this.$a.currentTime=this.$a.currentTime))}pc(){const{audioTracks:t}=this.b;this.gc&&this.gc.audioTrack!==t.selectedIndex&&(this.gc.audioTrack=t.selectedIndex)}ga(){var t,i;this.b&&(this.b.qualities[g.V]=void 0),(t=this.gc)==null||t.destroy(),this.gc=null,(i=this.hc)==null||i.call(this),this.hc=null}}class k{constructor(t,i,e){this.sc=t,this.b=i,this.kb=e,this.tc()}async tc(){const t={onLoadStart:this.Mb.bind(this),onLoaded:this.uc.bind(this),onLoadError:this.vc.bind(this)};let i=await j(this.sc,t);if(w(i)&&!l(this.sc)&&(i=await H(this.sc,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.b.player.dispatch(new h("hls-unsupported")),this.b.delegate.a("error",{message:e,code:4}),null}return i}Mb(){this.b.player.dispatch(new h("hls-lib-load-start"))}uc(t){this.b.player.dispatch(new h("hls-lib-loaded",{detail:t})),this.kb(t)}vc(t){const i=$(t);this.b.player.dispatch(new h("hls-lib-load-error",{detail:i})),this.b.delegate.a("error",{message:i.message,code:4})}}async function H(a,t={}){var i,e,r,s,o;if(!w(a)){if((i=t.onLoadStart)==null||i.call(t),a.prototype&&a.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,a),a;try{const n=(r=await a())==null?void 0:r.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(o=t.onLoadError)==null||o.call(t,n)}}}async function j(a,t={}){var i,e,r;if(l(a)){(i=t.onLoadStart)==null||i.call(t);try{if(await D(a),!C(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(r=t.onLoadError)==null||r.call(t,s)}}}const A="https://cdn.jsdelivr.net",f=class f extends O{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.da=null,this.ba=new q(this.video),this.ca=`${A}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.da}get instance(){return this.ba.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.ba.ea}set config(t){this.ba.ea=t}get library(){return this.ca}set library(t){this.ca=t}preconnect(){l(this.ca)&&E(this.ca)}setup(t){super.setup(t),new k(this.ca,t,i=>{this.da=i,this.ba.setup(i,t),t.delegate.a("provider-setup",this);const e=p(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;l(t.src)&&(this.h.preload=i||"",(e=this.ba.instance)==null||e.loadSource(t.src),this.n=t)}onInstance(t){const i=this.ba.instance;return i&&t(i),this.ba.fa.add(t),()=>this.ba.fa.delete(t)}destroy(){this.ba.ga()}};f.supported=m();let y=f;export{y as HLSProvider};
